package external

import (
	"context"

	"github.com/google/uuid"

	"github.com/aws/aws-sdk-go/aws"
	"github.com/aws/aws-sdk-go/aws/awserr"
	"github.com/aws/aws-sdk-go/service/cloudfront"
	"github.com/google/wire"
	"github.com/nao1215/spare/app/domain/model"
	"github.com/nao1215/spare/app/domain/service"
	"github.com/nao1215/spare/utils/errfmt"
)

// CDNCreatorSet is a provider set for CDNCreator.
//
//nolint:gochecknoglobals
var CDNCreatorSet = wire.NewSet(
	NewCloudFrontCDNCreator,
	wire.Bind(new(service.CDNCreator), new(*CloudFrontCDNCreator)),
)

// CloudFrontCDNCreator is an implementation for CDNCreator.
type CloudFrontCDNCreator struct {
	*cloudfront.CloudFront
}

var _ service.CDNCreator = &CloudFrontCDNCreator{}

// NewCloudFrontCDNCreator returns a new CloudFrontCDNCreator struct.
func NewCloudFrontCDNCreator(profile model.AWSProfile, region model.Region, endpoint *model.Endpoint) *CloudFrontCDNCreator {
	return &CloudFrontCDNCreator{
		CloudFront: cloudfront.New(newS3Session(profile, region, endpoint)),
	}
}

// CreateCDN creates a CDN.
func (c *CloudFrontCDNCreator) CreateCDN(ctx context.Context, input *service.CDNCreatorInput) (*service.CDNCreatorOutput, error) {
	createDistributionInput := &cloudfront.CreateDistributionInput{
		DistributionConfig: &cloudfront.DistributionConfig{
			Comment:         aws.String("CloudFront Distribution Generated by Spare"),
			CallerReference: aws.String(uuid.New().String()),
			DefaultCacheBehavior: &cloudfront.DefaultCacheBehavior{
				TargetOriginId:       aws.String("S3 Origin ID Generated by Spare"),
				ViewerProtocolPolicy: aws.String("redirect-to-https"),
				MinTTL:               aws.Int64(300),
				MaxTTL:               aws.Int64(300),
				DefaultTTL:           aws.Int64(300),
				AllowedMethods: &cloudfront.AllowedMethods{
					Items: []*string{
						aws.String("GET"),
						aws.String("HEAD"),
						aws.String("OPTIONS"),
					},
					Quantity: aws.Int64(3),
					CachedMethods: &cloudfront.CachedMethods{
						Items: []*string{
							aws.String("GET"),
							aws.String("HEAD"),
						},
						Quantity: aws.Int64(2),
					},
				},
				// Deprecated fields
				ForwardedValues: &cloudfront.ForwardedValues{
					QueryString: aws.Bool(true),
					Cookies: &cloudfront.CookiePreference{
						Forward: aws.String("none"),
					},
				},
			},
			DefaultRootObject: aws.String("index.html"),
			HttpVersion:       aws.String("http2and3"),
			PriceClass:        aws.String("PriceClass_100"),
			Origins: &cloudfront.Origins{
				Items: []*cloudfront.Origin{
					{
						Id:         aws.String("S3 Origin ID Generated by Spare"),
						DomainName: aws.String(input.BucketName.Domain()),
						S3OriginConfig: &cloudfront.S3OriginConfig{
							OriginAccessIdentity: aws.String(""),
						},
					},
				},
				Quantity: aws.Int64(1),
			},
			Enabled: aws.Bool(true),
		},
	}

	output, err := c.CreateDistribution(createDistributionInput)
	if err != nil {
		if aerr, ok := err.(awserr.Error); ok {
			switch aerr.Code() {
			case cloudfront.ErrCodeDistributionAlreadyExists:
				return nil, service.ErrCDNAlreadyExists
			default:
			}
		}
		return nil, errfmt.Wrap(err, "failed to create a cloudfront distribution")
	}

	return &service.CDNCreatorOutput{
		Domain: model.Domain(*output.Distribution.DomainName),
	}, nil
}
